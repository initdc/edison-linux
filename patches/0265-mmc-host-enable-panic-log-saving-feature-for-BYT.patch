From dbbfbcf5c7875168fe43492c3ac17a0009fb3e09 Mon Sep 17 00:00:00 2001
From: Dong Chuanxiao <chuanxiao.dong@intel.com>
Date: Fri, 16 Aug 2013 14:57:53 +0800
Subject: [PATCH 265/429] mmc: host: enable panic log saving feature for BYT

enable the panic log saving feature for BYT platform

Signed-off-by: Chuanxiao Dong <chuanxiao.dong@intel.com>
Signed-off-by: Ning Feiyi <feiyix.ning@intel.com>
---
 drivers/mmc/host/sdhci-pci.c |  1 +
 drivers/mmc/host/sdhci.c     | 29 +++++++++++++++++------------
 2 files changed, 18 insertions(+), 12 deletions(-)

diff --git a/drivers/mmc/host/sdhci-pci.c b/drivers/mmc/host/sdhci-pci.c
index 045d92322ced..10e5a64d5d7a 100644
--- a/drivers/mmc/host/sdhci-pci.c
+++ b/drivers/mmc/host/sdhci-pci.c
@@ -595,6 +595,7 @@ static int byt_emmc_probe_slot(struct sdhci_pci_slot *slot)
 {
 	slot->host->mmc->caps |= MMC_CAP_8_BIT_DATA | MMC_CAP_NONREMOVABLE;
 	slot->host->mmc->caps2 |= MMC_CAP2_HC_ERASE_SZ;
+
 	return 0;
 }
 
diff --git a/drivers/mmc/host/sdhci.c b/drivers/mmc/host/sdhci.c
index 3d6f95734036..18c638bf8807 100644
--- a/drivers/mmc/host/sdhci.c
+++ b/drivers/mmc/host/sdhci.c
@@ -3393,7 +3393,7 @@ static int sdhci_mfld_panic_acquire_ownership(struct sdhci_host *host)
 	unsigned long t1, t2;
 
 	if (!host->sram_addr)
-		return 0;
+		return DEKKER_OWNER_IA;
 
 	/* If IA has already hold the eMMC mutex, then just exit */
 	if (readl(host->sram_addr + DEKKER_IA_REQ_OFFSET))
@@ -3438,7 +3438,8 @@ static int sdhci_mfld_panic_acquire_ownership(struct sdhci_host *host)
 			readl(host->sram_addr + DEKKER_IA_REQ_OFFSET),
 			readl(host->sram_addr + DEKKER_SCU_REQ_OFFSET));
 
-	return 0;
+	return (readl(host->sram_addr + DEKKER_EMMC_OWNER_OFFSET) ==
+		DEKKER_OWNER_IA) ? DEKKER_OWNER_SCU : DEKKER_OWNER_IA;
 timeout:
 
 	pr_warn("%s: Timeout to hold eMMC mutex\n", __func__);
@@ -3467,14 +3468,9 @@ static int sdhci_mfld_panic_power_on(struct mmc_panic_host *panic_host)
 			if (ret)
 				return ret;
 		}
+		sdhci_panic_reinit_host(panic_host);
+		host->runtime_suspended = false;
 	}
-	host->runtime_suspended = false;
-
-	/*
-	 * re-init host controller in case SCU FW has changed something
-	 */
-
-	sdhci_panic_reinit_host(panic_host);
 
 	return 0;
 }
@@ -3490,10 +3486,19 @@ static int sdhci_mfld_panic_hold_mutex(struct mmc_panic_host *panic_host)
 	host = panic_host->priv;
 
 	ret = sdhci_mfld_panic_acquire_ownership(host);
-	if (ret)
-		return ret;
 
-	return sdhci_mfld_panic_power_on(panic_host);
+	if (ret == DEKKER_OWNER_SCU) {
+		if (host->ops->power_up_host) {
+			ret = host->ops->power_up_host(host);
+			if (ret)
+				return ret;
+		}
+		sdhci_panic_reinit_host(panic_host);
+		return 0;
+	} else if (ret == DEKKER_OWNER_IA)
+		return sdhci_mfld_panic_power_on(panic_host);
+
+	return ret;
 }
 
 static void sdhci_mfld_panic_release_mutex(struct mmc_panic_host *panic_host)
-- 
2.37.3

