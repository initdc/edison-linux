From 7cd5321200333a3bce0fe14dd857b11a9303df2e Mon Sep 17 00:00:00 2001
From: Simon Desfarges <simonx.desfarges@intel.com>
Date: Wed, 24 Sep 2014 15:25:09 +0200
Subject: [PATCH 373/429] spi: do not allow bits_per_word < 4 in spi_transfer

Signed-off-by: Simon Desfarges <simonx.desfarges@intel.com>
---
 drivers/spi/intel_mid_ssp_spi.c | 17 ++++++++++-------
 1 file changed, 10 insertions(+), 7 deletions(-)

diff --git a/drivers/spi/intel_mid_ssp_spi.c b/drivers/spi/intel_mid_ssp_spi.c
index 3d3dcf341347..938180e49e08 100644
--- a/drivers/spi/intel_mid_ssp_spi.c
+++ b/drivers/spi/intel_mid_ssp_spi.c
@@ -1005,6 +1005,16 @@ static int handle_message(struct ssp_drv_context *sspc)
 			cr0 = saved_cr0;
 		}
 
+		if ((bits_per_word < MIN_BITS_PER_WORD
+					|| bits_per_word > MAX_BITS_PER_WORD)) {
+			dev_warn(dev, "invalid wordsize\n");
+			msg->status = -EINVAL;
+			if (msg->complete)
+				msg->complete(msg->context);
+			complete(&sspc->msg_done);
+			return 0;
+		}
+
 		/* Check message length and bit per words consistency */
 		if (bits_per_word <= 8)
 			mask = 0;
@@ -1046,13 +1056,6 @@ static int handle_message(struct ssp_drv_context *sspc)
 			sspc->n_bytes = 4;
 			sspc->read = u32_reader;
 			sspc->write = u32_writer;
-		} else {
-			dev_warn(dev, "invalid wordsize\n");
-			msg->status = -EINVAL;
-			if (msg->complete)
-				msg->complete(msg->context);
-			complete(&sspc->msg_done);
-			return 0;
 		}
 		sspc->tx  = (void *)transfer->tx_buf;
 		sspc->rx  = (void *)transfer->rx_buf;
-- 
2.37.3

