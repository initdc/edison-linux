From 77c395b1473cbb8b782ed25fd1fcea454e9ea87d Mon Sep 17 00:00:00 2001
From: Axel Haslam <axelx.haslam@intel.com>
Date: Sun, 7 Jul 2013 03:03:54 +0200
Subject: [PATCH 028/429] SFI: Added SD device support

Added SD device support for SFI parsing table.

Signed-off-by: Sathyanarayanan Kuppuswamy <sathyanarayanan.kuppuswamy@intel.com>
Signed-off-by: Axel Haslam <axelx.haslam@intel.com>
---
 arch/x86/platform/intel-mid/intel_mid_sfi.c | 24 ++++++++++++++++++++-
 include/linux/sfi.h                         |  1 +
 2 files changed, 24 insertions(+), 1 deletion(-)

diff --git a/arch/x86/platform/intel-mid/intel_mid_sfi.c b/arch/x86/platform/intel-mid/intel_mid_sfi.c
index 622dacd374ca..db697984483a 100644
--- a/arch/x86/platform/intel-mid/intel_mid_sfi.c
+++ b/arch/x86/platform/intel-mid/intel_mid_sfi.c
@@ -402,6 +402,26 @@ static void __init sfi_handle_i2c_dev(struct sfi_device_table_entry *pentry,
 		i2c_register_board_info(pentry->host_num, &i2c_info, 1);
 }
 
+static void __init sfi_handle_sd_dev(struct sfi_device_table_entry *pentry,
+					struct devs_id *dev)
+{
+	struct sd_board_info sd_info;
+	void *pdata = NULL;
+
+	memset(&sd_info, 0, sizeof(sd_info));
+	strncpy(sd_info.name, pentry->name, 16);
+	sd_info.bus_num = pentry->host_num;
+	sd_info.board_ref_clock = pentry->max_freq;
+	sd_info.addr = pentry->addr;
+	pr_info("SDIO bus = %d, name = %16.16s, "
+			"ref_clock = %d, addr =0x%x\n",
+			sd_info.bus_num,
+			sd_info.name,
+			sd_info.board_ref_clock,
+			sd_info.addr);
+	pdata = dev->get_platform_data(&sd_info);
+	sd_info.platform_data = pdata;
+}
 struct devs_id *get_device_id(u8 type, char *name)
 {
 	struct devs_id *dev = device_ids;
@@ -448,7 +468,6 @@ static int __init sfi_parse_devs(struct sfi_table_header *table)
 			irq_attr.polarity = 1;
 			io_apic_set_pci_routing(NULL, irq, &irq_attr);
 		}
-
 		dev = get_device_id(pentry->type, pentry->name);
 
 		if ((dev == NULL) || (dev->get_platform_data == NULL))
@@ -467,6 +486,9 @@ static int __init sfi_parse_devs(struct sfi_table_header *table)
 			case SFI_DEV_TYPE_I2C:
 				sfi_handle_i2c_dev(pentry, dev);
 				break;
+			case SFI_DEV_TYPE_SD:
+				sfi_handle_sd_dev(pentry, dev);
+				break;
 			case SFI_DEV_TYPE_HSI:
 			case SFI_DEV_TYPE_UART:
 			default:
diff --git a/include/linux/sfi.h b/include/linux/sfi.h
index c80ab80a4fd3..cd50488215b2 100644
--- a/include/linux/sfi.h
+++ b/include/linux/sfi.h
@@ -157,6 +157,7 @@ struct sfi_device_table_entry {
 #define SFI_DEV_TYPE_UART	2
 #define SFI_DEV_TYPE_HSI	3
 #define SFI_DEV_TYPE_IPC	4
+#define SFI_DEV_TYPE_SD		5
 
 	u8	host_num;	/* attached to host 0, 1...*/
 	u16	addr;
-- 
2.37.3

